# IncSpec 兼容性策略（Compatibility Policy）

> 本文定义 IncSpec 在 v1.0.0 正式版发布前的向后兼容策略、弃用流程与发版门禁（Release Gate）检查清单。  
> 目标：在持续迭代功能的同时，确保 **整体可执行、可验证、可监控、可协调**。

## 关联文档（Cross-links）

- 发版门禁（执行层清单）：`roadmap/release-gate.md`
- 模板同步策略与模板一致性统一规范：`roadmap/template-sync-strategy.md`
- 路线图总览（含跨阶段约束摘要）：`roadmap/ROADMAP.md`

## 1. 适用范围与目标

### 1.1 兼容窗口
- **兼容窗口**：从当前版本起，直到 **v1.0.0** 正式版发布。
- 在兼容窗口内：默认遵循“**新增不破坏**”，避免改变既有用户脚本与工作流心智模型。

### 1.2 兼容目标
- 保持当前「增量规范驱动开发」7 步工作流（含 QUICK/FULL）语义稳定。
- 保持 CLI 命令与参数在既有用法下可继续工作（除非明确弃用并提供迁移路径）。
- 保持 `templates/` 与 CLI 同步，确保 AI 工具协同能力不会因版本升级失效。
- 提供最小可观测数据以验证体验指标（错误率、延迟、任务成功率等）。

---

## 2. 兼容对象（Compatibility Contract）

以下对象在 v1.0.0 前默认视为 **兼容契约**。任何破坏契约的变更必须走“弃用与迁移策略”。

### 2.1 CLI 命令/别名/参数
包含但不限于：
- 命令名称与其别名（例如 `analyze` / `a`）。
- 参数名称、含义、默认值、是否必填。
- 主要输出（用户可依赖的信息结构、关键字段与含义）。

**政策**：
- 新能力优先以“**新增命令/新增参数**”方式交付。
- 必须修改行为时，优先新增开关参数（例如 `--new-behavior`、`--format=json`）而不是改变默认语义。
- 若输出被工具链/模板解析依赖，输出结构应版本化或保持稳定。

### 2.2 工作流状态机与文件
包含但不限于：
- 7 步工作流步骤定义与含义。
- `STATUS` 枚举、推进规则、`MODE`（FULL/QUICK）语义。
- `WORKFLOW.md` 的关键字段与结构（若存在结构化字段/标记）。

**政策**：
- 变更 `WORKFLOW.md` 的结构/字段属于高风险；必须提供迁移策略与回滚策略。
- QUICK 模式跳过的步骤语义不得反转（例如原跳过 3/4，不应在兼容窗口内悄然改变）。

### 2.3 `incspec/` 目录结构与 spec 命名规则
包含但不限于：
- `baselines/requirements/increments/archives` 及归档层级结构。
- spec 文件版本命名规则（例如 `*-v{version}.md`）。
- 归档搬运规则、模块名推断规则。

**政策**：
- 任何目录/命名规则变更必须提供自动迁移（或至少提供明确迁移指令与检测提示）。
- “自动推断”逻辑更新必须保证旧项目不会因推断变化导致行为错误（必要时允许用户显式覆盖）。

### 2.4 `templates/` 与 AI 工具协同入口
包含但不限于：
- `templates/AGENTS.md`
- `templates/commands/*`（按需）

**政策**：
- CLI 功能变更必须同步更新模板（不可选）。
- 模板必须与 CLI 参数/示例保持一致。
- 发版必须通过模板一致性校验（见第 5 节）。

---

## 3. 破坏性变更（Breaking Change）判定

以下情况通常视为破坏性变更（需要弃用流程）：

### 3.1 CLI 层
- 删除/重命名命令或别名。
- 改变参数含义或默认值导致旧命令产生不同结果。
- 取消原本可用的输出信息或改变其关键语义。
- 将原本可脚本化的输出改为仅交互式输出。

### 3.2 工作流层
- 改变步骤顺序、步骤含义或状态推进规则。
- 修改 QUICK/FULL 模式包含的步骤集合或语义。
- 修改 `WORKFLOW.md` 的关键字段导致旧项目无法读取/恢复状态。

### 3.3 数据/文件系统层
- 改变 `incspec/` 目录结构或 spec 命名规则，造成旧脚本/工具无法定位文件。
- 归档规则变化导致历史产物无法被正确识别/恢复。

### 3.4 模板协同层
- CLI 新增参数/命令但模板未同步。
- 模板示例与 CLI 行为不一致（会直接导致 AI 使用错误）。

---

## 4. 弃用与迁移策略（Deprecation Plan）

### 4.1 总原则
- **新增 > 修改默认行为 > 移除**
- 兼容窗口内尽量不移除能力；必要移除通常推迟到 v1.0.0 之后或在 v1.0.0 保留兼容层。

### 4.2 三阶段弃用流程
1. **warn（告警期）**
   - 仍支持旧用法
   - 输出弃用提示：说明将被替代的用法、推荐替代用法、文档链接
2. **soft（软迁移期）**
   - 旧用法仍可用，但文档/模板默认改为新用法
   - 新用法成为推荐路径
3. **remove@v1.0+（移除期）**
   - v1.0.0 发布后才允许移除旧用法（或在 v1.0.0 保留兼容层，后续小版本再移除）

### 4.3 迁移要求
任何弃用项必须提供至少一种迁移手段：
- 推荐替代命令/参数
- 自动迁移脚本或命令（如果可行）
- 明确的手工迁移步骤（至少包含“如何确认迁移成功”）

---

## 5. Release Gate（发版门禁）检查清单

> 每次发版（含 pre-release）必须通过以下最小门禁，以保障可执行/可验证/可监控/可协调。

### 5.1 可执行（Execution）
- [ ] 所有新增/变更命令具备 `--help` 完整说明（含最少 1 个示例）
- [ ] 对用户有影响的行为变更有明确说明（Release Notes）
- [ ] 若引入第三方依赖：记录引入原因、替代方案、许可证、降级路径

### 5.2 可验证（Verification）
- [ ] 模板一致性校验通过（CLI ↔ templates）
- [ ] 最小回归路径通过（至少覆盖主工作流路径）
- [ ] 对新增功能的最小自动化测试/冒烟测试脚本存在且可运行
- [ ] 兼容性测试：旧用法仍可执行（如果存在弃用项，至少覆盖 warn/soft 路径）

### 5.3 可监控（Observability）
- [ ] 命令级别最小观测数据可用（耗时、成功/失败、错误码）
- [ ] 关键事件有记录（例如工作流步骤推进、reset、merge、archive）
- [ ] 输出能够用于定位问题（错误信息包含建议与上下文）

> 说明：默认只要求本地观测数据；如果后续引入远程上报，需要明确用户授权与隐私策略。

### 5.4 可协调（Coordination）
- [ ] Release Notes/CHANGELOG 更新：新增、修复、弃用、迁移提示
- [ ] 文档与模板与发版同步更新（不可选）
- [ ] 如有 breaking change：必须在 Release Notes 明确标注并提供迁移方案
- [ ] 版本号与路线图里程碑对齐（不对齐需说明原因）

---

## 6. 模板同步与一致性要求

- CLI 功能开发 = CLI 代码 + 对应模板更新
- 模板更新与 CLI 发布同步，不是可选项
- 每个 PR 必须包含相关模板更新或明确说明“无模板影响”
- 推荐在 CI 中加入“模板一致性校验”，至少检查：
  - CLI 命令列表是否都有对应的模板入口说明
  - CLI 参数是否在模板中体现
  - 示例命令是否与当前版本一致

---

## 7. 指标（Metrics）口径建议（最小版）

> 用于支撑路线图中的“错误率、延迟、转化率、任务成功率”等指标。具体实现可先本地落地，逐步完善。

- **错误率**：命令执行失败次数 / 命令执行总次数（按命令维度、版本维度）
- **延迟**：命令耗时分布（P50/P90/P99）与分阶段耗时（工作流 step duration）
- **转化率**：例如 `init → analyze`、`analyze → collect-req` 的完成转化（以工作流事件统计）
- **任务成功率**：一个工作流从开始到 `archive` 的成功占比（区分 FULL/QUICK）

---

## 8. 变更记录

- 2025-12-23：初版，定义兼容窗口到 v1.0.0，并补充 Release Gate 门禁清单