# IncSpec Release Gate（发版门禁）

> 目标：把每次发版变成可重复的“质量闭环”，确保整体 **可执行（Execution）/ 可验证（Verification）/ 可监控（Observability）/ 可协调（Coordination）**。  
> 适用：所有版本发布（含 pre-release、RC），直到 v1.0.0 及之后。

---

## 0. 总则

### 0.1 为什么需要 Release Gate
IncSpec 是一个 CLI，但它与 AI 工具（Cursor、Claude Code 等）紧密协同。任何 CLI 变更如果没有同步模板与验证，会导致：
- AI 指令与 CLI 行为不一致（用户体验断裂）
- 用户脚本/工作流状态机破坏（兼容性风险）
- 难以量化“错误率下降、延迟改善、任务成功率提升”等指标（不可测）

Release Gate 的作用是：把“做完功能”升级为“可发布的功能”。

### 0.2 适用范围（Gate 覆盖对象）
- CLI：命令、别名、参数、默认值、输出
- 工作流：7 步状态机（含 QUICK/FULL）
- 文件系统与规范：`incspec/` 目录结构、spec 命名/归档规则
- 模板：`templates/AGENTS.md` 及补充指令模板
- 文档：README、迁移说明、路线图与阶段文档（如产生影响）

### 0.3 Gate 级别
- **MUST**：不满足则禁止发布
- **SHOULD**：强建议；若不满足必须在 Release Notes 解释原因与后续计划
- **MAY**：可选优化项

---

## 1. Execution（可执行）

> 关注点：用户能否“按文档就能跑通”，以及是否存在明确的降级路径。

### 1.1 MUST：CLI 可用性
- [ ] 所有新增/变更命令具备 `--help`，包含：
  - 用途说明
  - 最少 2 个示例（典型路径 + 边界/常见用法）
  - 关键参数解释（含默认值/可选值/互斥关系）
- [ ] 新增命令在未初始化、已有工作流、异常输入等场景下有可理解的错误信息并提供建议（至少 1 条可执行建议）
- [ ] 交互式命令（如向导）提供非交互替代或明确说明无法脚本化的原因与可替代路径（例如 `--yes`/`--dry-run`/`--json` 等）

### 1.2 MUST：模板同步可用
- [ ] CLI 变更涉及命令/参数/行为时：
  - [ ] `templates/AGENTS.md` 更新
- [ ] 如新增命令需要更细说明（可选但常见）：
  - [ ] `templates/commands/*` 增补（Cursor/Claude Code 通用）

### 1.3 SHOULD：依赖引入与降级策略
如本次版本引入或升级第三方依赖：
- [ ] 记录引入原因：提升体验/效率的具体点（例如交互、渲染、解析性能）
- [ ] 记录替代方案评估（至少说明“无需依赖的降级模式”是否存在）
- [ ] 记录许可证与维护风险（维护活跃度、体积、兼容性）
- [ ] 提供降级路径（例如禁用 TUI、回落到纯文本输出）

---

## 2. Verification（可验证）

> 关注点：发布前是否能通过自动化与冒烟流程证明“功能可用 + 兼容未破坏”。

### 2.1 MUST：模板一致性校验（统一规范）
模板一致性校验必须遵循统一规范：`roadmap/template-sync-strategy.md` 中的 **“模板一致性校验规范（Unified Template Consistency Validation）”**。

至少要验证（可以用脚本或命令）：

**A. 核心入口一致性（MUST）**
- [ ] `templates/AGENTS.md` 存在且可读取
- [ ] 若本次发版涉及 CLI 新增/变更命令、参数、默认行为或工作流语义：该文件必须同步更新并反映变化（含至少 1 个示例或明确说明）

**B. 命令覆盖一致性（MUST）**
- [ ] 每个 CLI 命令至少在 AGENTS.md 中"可被发现"（可通过文本检索/索引/命令清单对照实现）
- [ ] 对"关键命令"（新增命令、工作流关键入口、CI/自动化调用命令、交互/降级复杂命令）：
  - [ ] `templates/commands/` 具备补充说明（Cursor/Claude Code 通用）
  - [ ] 若未补充，必须在 Release Notes 说明原因与风险（例如"内部命令/不推荐给 AI 直接触发"）

**C. 参数一致性（MUST）**
- [ ] 模板中出现的参数名（长/短选项）与 CLI 一致
- [ ] 参数语义、默认值与互斥关系与 CLI 一致
- [ ] 模板示例命令对齐当前 CLI（示例在“格式与参数层面”可执行）
- [ ] 对弃用参数：模板不得继续推荐；如仍支持旧用法，必须标注弃用与迁移用法

**D. 输出/格式一致性（SHOULD）**
- [ ] 若 CLI 支持机器可读输出（例如 `--json` / `--format=json`），模板需说明何时使用及关键字段/示例
- [ ] 若输出结构变化会影响解析：必须在模板与 Release Notes 同步更新，并按兼容策略提供迁移提示

### 2.2 MUST：核心工作流冒烟（主路径）
对于一个最小示例项目（或仓库自带 fixture），至少验证：
- [ ] 初始化路径可用：`init`（或通过向导触发 init）
- [ ] 主工作流可走通（按项目默认模式）：
  - analyze → collect-req → apply → merge → archive
- [ ] QUICK/FULL 模式的关键分岔具备预期行为（至少验证“不会异常中断/状态混乱”）

### 2.3 MUST：向后兼容冒烟
- [ ] 旧的命令别名仍可用（如项目已有别名体系）
- [ ] 旧的参数/默认行为未被悄然改变（如存在弃用项，至少处于 warn/soft 阶段并可继续运行）
- [ ] `WORKFLOW.md` 状态读取/推进行为兼容旧项目产物（必要时提供迁移提示）

### 2.4 SHOULD：最小自动化测试
- [ ] 至少存在一组自动化测试或可重复脚本，覆盖：
  - 参数解析与错误处理
  - 工作流状态推进
  - spec 读写（baseline/requirement/increment/archive）
  - 模板同步校验
- [ ] 对新增功能提供最少 1 个回归用例（避免后续重复踩坑）

---

## 3. Observability（可监控）

> 关注点：你能否量化验证路线图指标（错误率、延迟、完成率），以及能否定位问题。

### 3.1 MUST：最小观测数据（本地）
至少保证本地可获得（默认不要求远程上报）：
- [ ] 命令级事件：
  - 命令名、开始/结束时间、耗时、成功/失败、错误码
- [ ] 工作流关键事件：
  - workflow 开始/结束
  - step 状态变更（pending/in_progress/completed/skipped）
- [ ] 错误内容可诊断：
  - 错误信息包含可执行建议（至少 1 条）
  - 若存在文档链接则必须有效

> 建议：提供导出能力（例如 `--json`）以便 CI 与 AI 工具消费。

### 3.2 SHOULD：性能与资源监控（最小）
- [ ] 大型项目运行时至少能输出耗时分段（或关键阶段耗时）
- [ ] 明确潜在的长时运行命令（如 watch）资源占用与退出方式

### 3.3 MAY：告警与阈值
- [ ] 为关键指标设置阈值（例如耗时超时、内存异常、缓存命中率过低）
- [ ] 给出操作建议（例如“建议开启缓存/缩小分析范围”）

---

## 4. Coordination（可协调）

> 关注点：外部用户/贡献者能否理解“这次发版改了什么、怎么升级、哪里会受影响”。

### 4.1 MUST：Release Notes / CHANGELOG
每个版本必须包含：
- [ ] 新增（Added）
- [ ] 修复（Fixed）
- [ ] 变更（Changed）——尤其是默认行为变化
- [ ] 弃用（Deprecated）与迁移建议
- [ ] 破坏性变更（Breaking Changes）——若发生必须清晰标注并给迁移步骤

### 4.2 MUST：模板与文档同步
- [ ] 模板更新与 CLI 发布同步（不可选）
- [ ] 路线图/阶段文档若与实现偏离，必须补充“偏离说明”或调整版本计划

### 4.3 SHOULD：升级指南（当需要时）
以下情况需要提供升级指南（可以很短）：
- `WORKFLOW.md` 结构变化
- `incspec/` 目录结构/命名变化
- 默认行为变化（尤其是影响脚本/CI 的）
- 关键命令参数变化

---

## 5. Gate 执行流程（建议）

### 5.1 开发阶段（Dev）
- 在实现功能的同时同步更新模板与文档
- 避免最后集中补文档导致不一致

### 5.2 PR 阶段（Review）
- 每个 PR 需要自检：
  - 本次变更是否影响 CLI/模板/工作流？
  - 是否触发弃用流程？
  - 是否需要补充冒烟用例？

### 5.3 发布阶段（Release）
- 通过全部 MUST 项
- 生成 Release Notes
- 标记本版本的兼容性声明（是否含弃用项、是否引入新依赖）

---

## 6. 常见例外（如何“放行”）
如果确实无法满足某些 SHOULD/MAY：
- 在 Release Notes 中写清楚：
  - 缺失项是什么
  - 风险是什么
  - 临时替代方案是什么
  - 计划在哪个版本补齐

**禁止放行**：任何 MUST 未满足的版本。

---

## 7. 变更记录
- 2025-12-23：初版，定义 Execution/Verification/Observability/Coordination 四维门禁
